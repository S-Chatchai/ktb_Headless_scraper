const puppeteer = require("puppeteer");
const fs = require("fs");
const path = require("path");
const { spawn } = require("child_process");
require("dotenv").config();
const nodemailer = require("nodemailer");
const { GoogleGenerativeAI } = require("@google/generative-ai");

// dynamic fetch import for Node.js CommonJS
const fetch = (...args) => import("node-fetch").then(({ default: fetch }) => fetch(...args));

// --- Setup Gemini API Key Rotation ---
const geminiKeys = process.env.GEMINI_API_KEYS ?
    process.env.GEMINI_API_KEYS.split(",") :
    ["YOUR_API_KEY_HERE"];
let geminiKeyIndex = 0;

function getNextGeminiKey() {
    const key = geminiKeys[geminiKeyIndex];
    geminiKeyIndex = (geminiKeyIndex + 1) % geminiKeys.length;
    return key;
}

// --- Email Config ---
const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
        user: process.env.GMAIL_USER || "GMAIL_USER",
        pass: process.env.GMAIL_PASS || "GMAIL_PASS"
    }
});

// --- Folders for saving ---
const folderPath = path.join(__dirname, "instapost");
const geminiFolder = path.join(__dirname, "geminitext");
if (!fs.existsSync(folderPath)) fs.mkdirSync(folderPath);
if (!fs.existsSync(geminiFolder)) fs.mkdirSync(geminiFolder);
if (!fs.existsSync(path.join(__dirname, "downloads"))) fs.mkdirSync(path.join(__dirname, "downloads"));

// --- File to store last scraped posts ---
const lastPostFile = path.join(__dirname, "lastPost.json");

// --- Convert media to base64 ---
function mediaToBase64(filePath) {
    const mediaBuffer = fs.readFileSync(filePath);
    return mediaBuffer.toString("base64");
}

// --- Scrape caption + timestamp + media ---
async function scrapePost(browser, url) {
    const page = await browser.newPage();
    await page.goto(url, { waitUntil: "networkidle2" });

    // 2. üõ°Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ (time) element ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
    try {
        await page.waitForSelector("time", { timeout: 10000 }); // ‡∏£‡∏≠‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    } catch (error) {
        console.warn(`‚ö†Ô∏è Time element not found within timeout on ${url}. Proceeding with best effort.`);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    }

    // 3. ‡∏î‡∏∂‡∏á timestamp (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ $eval ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô try/catch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏á)
    let timestamp = "No timestamp";
    try {
        timestamp = await page.$eval("time", el => el.getAttribute("datetime"));
    } catch (e) {
        // ‡∏ñ‡πâ‡∏≤ $eval ‡∏û‡∏±‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏≤ time ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
    }

    const caption = await page.evaluate(() => {
        const h1 = document.querySelector("h1");
        if (h1?.innerText.trim().length) return h1.innerText.trim();

        const reelSpan = document.querySelector("div[role='presentation'] div span");
        if (reelSpan?.innerText.trim().length) return reelSpan.innerText.trim();

        const longSpan = Array.from(document.querySelectorAll("span"))
            .find(el => el.innerText && el.innerText.length > 20);
        return longSpan ? longSpan.innerText.trim() : "No caption";
    });

    const media = await page.evaluate(() => {
        const video = document.querySelector("video");
        if (video?.src) return { type: "video", url: video.src };

        const imgs = Array.from(document.querySelectorAll("div img"))
            .map(el => el.src)
            .filter(src => src && !src.includes("profile") && !src.includes("emoji"));
        if (imgs.length > 0) return { type: "image", url: imgs[0] };

        return { type: "none", url: null };
    });

    await page.close();
    return { url, timestamp, caption, media };
}

// --- Download image or call Python for video ---
async function downloadMedia(media, fileName, url) {
    if (!media || !media.url) return null;

    if (media.type === "image") {
        try {
            const fileNameBase = fileName.replace(".txt", ".jpg");
            const filePath = path.join(folderPath, fileNameBase);

            const res = await fetch(media.url);
            const buffer = Buffer.from(await res.arrayBuffer());
            fs.writeFileSync(filePath, buffer);

            console.log(`üñºÔ∏è Image saved to ${filePath}`);
            return filePath;
        } catch (err) {
            console.error("‚ùå Failed to download image:", err);
            return null;
        }
    }

    if (media.type === "video") {
        return new Promise((resolve, reject) => {
            const customVideoName = fileName.replace(".txt", ".mp4");
            const pythonProcess = spawn("python", ["download_instagram_video.py", url, customVideoName]);

            pythonProcess.stdout.on("data", (data) => console.log(`${data}`));
            pythonProcess.stderr.on("data", (data) => console.error(`${data}`));

            pythonProcess.on("close", (code) => {
                if (code === 0) {
                    const downloadedFile = path.join(__dirname, "downloads", customVideoName);
                    console.log(`üé¨ Video saved to ${downloadedFile}`);
                    resolve(downloadedFile);
                } else {
                    reject(`Python process exited with code ${code}`);
                }
            });
        });
    }

    return null;
}

// --- Call Gemini to analyze caption + media with key rotation and retry logic ---
async function analyzeWithGemini(caption, mediaPath, mediaType) {
    const maxRetries = 3;
    let retries = 0;
    let delay = 1000; // 1 second

    while (retries < maxRetries) {
        try {
            const apiKey = getNextGeminiKey();
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

            const parts = [{
                text: `‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏° (Responsible Lending) ‡∏Ç‡∏≠‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢

‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô

‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ Caption ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ ‚Äú‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‚Äù ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏±‡∏Å‡∏ä‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô:

‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• / ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î / ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô / ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ / ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ SME

‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏Å‡∏ä‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏Å‡∏π‡πâ‡∏á‡πà‡∏≤‡∏¢‚Äù, ‚Äú‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‚Äù, ‚Äú‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‚Äù, ‚Äú‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‚Äù, ‚Äú‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‚Äù

‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î ‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°

‡πÑ‡∏°‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏≤‡∏Å‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô:

‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°, ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô)

‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏

‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ‡∏´‡∏∏‡πâ‡∏ô ‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ

‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏°‡∏¥‡∏à‡∏â‡∏≤‡∏ä‡∏µ‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£

‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô

‡∏ñ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤: ‚Äú‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‚Äù

‡∏ñ‡πâ‡∏≤ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤: ‚Äú‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ

‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á)
‡∏ñ‡πâ‡∏≤‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ ‚Üí COMPLY: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ß‡πà‡∏≤‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£

‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á ‚Üí NOT COMPLY: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠ ‡πÜ ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå (1, 2, ‡∏´‡∏£‡∏∑‡∏≠ 3) ‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô

‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö 2)

1. ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ï‡πâ‡∏≠‡∏á "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"
‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏ö‡∏¥‡∏î‡πÄ‡∏ö‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡πÉ‡∏ô‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç.
‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô.
‡∏´‡∏≤‡∏Å‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏π‡∏á‡πÉ‡∏à ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô.
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ß‡πà‡∏≤ "‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ 0%" ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.

2. ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ï‡πâ‡∏≠‡∏á "‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏î‡πâ"
‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πà‡∏≠‡∏õ‡∏µ (Effective Interest Rate)" ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß) ‡πÉ‡∏ô‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô.
‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏≠‡∏¢‡∏ï‡∏±‡∏ß (Floating Rate) ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏•‡∏á‡πÑ‡∏î‡πâ".
‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏π‡∏á‡πÉ‡∏à‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô, ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÉ‡∏ô‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô.

3. ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ï‡πâ‡∏≠‡∏á "‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏£"
‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ:
‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "‡∏Å‡∏π‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏´‡∏ß" ‡πÉ‡∏ô‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô.
‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤ "‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)".
‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ:
‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ ‡πÄ‡∏ä‡πà‡∏ô "‡πÉ‡∏Ñ‡∏£ ‡πÜ ‡∏Å‡πá‡∏Å‡∏π‡πâ‡πÑ‡∏î‡πâ", "‡∏Å‡∏π‡πâ‡∏á‡πà‡∏≤‡∏¢", ‚Äú‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡πà‡∏≤‡∏¢", "‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏π‡πÇ‡∏£", "‡∏ï‡∏¥‡∏î‡∏ö‡∏π‡πÇ‡∏£‡∏Å‡πá‡∏Å‡∏π‡πâ‡πÑ‡∏î‡πâ".
‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "‡πÑ‡∏Æ‡πÇ‡∏ã‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á".
‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏Å‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÅ‡∏Ñ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£" ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠.

‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:
‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏™‡πà JSON, code block ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô

‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:
Caption: ${caption}`
            }];

            if (mediaPath && fs.existsSync(mediaPath)) {
                const base64Data = mediaToBase64(mediaPath);

                if (mediaType === "video") {
                    parts.push({
                        inlineData: {
                            mimeType: "video/mp4",
                            data: base64Data
                        }
                    });
                } else if (mediaType === "image") {
                    parts.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: base64Data
                        }
                    });
                }
            }

            const result = await model.generateContent(parts);
            let text = result.response.text().trim();
            text = text.replace(/^json\s*/i, "").replace(/```/g, "").trim();
            return text;
        } catch (err) {
            if (err.status === 503 && retries < maxRetries - 1) {
                console.warn(`‚ö†Ô∏è Gemini API 503 error. Retrying in ${delay / 1000} seconds...`);
                await new Promise(resolve => setTimeout(resolve, delay));
                retries++;
                delay *= 2; // Double the delay for the next attempt
            } else {
                throw err;
            }
        }
    }
}

// --- Send email (MODIFIED to accept custom subject) ---
async function sendEmail(post, geminiResult, mediaPath, customOptions = {}) {
    const attachments = mediaPath ? [{ filename: path.basename(mediaPath), path: mediaPath }] : [];

    // Use custom subject if provided, otherwise default subject
    const subject = customOptions.subject || `‚úÖ YES - Instagram Post ${post.timestamp}`;

    const mailOptions = {
        from: process.env.GMAIL_USER,
        to: [process.env.GMAIL_USER], //"ammarin.wangkeeree@krungthai.com"]
        subject: subject,
        text: `URL: ${post.url}\nTimestamp: ${post.timestamp}\nCaption: ${post.caption}\n\nGemini Result:\n${geminiResult}`,
        attachments
    };

    try {
        await transporter.sendMail(mailOptions);
        console.log("üìß Email sent successfully.");
    } catch (err) {
        console.error("‚ùå Error sending email:", err);
    }
}

// --- Scrape newest posts (MODIFIED logic for NOT COMPLY email) ---
async function scrapeNewestPosts(count = 5, delaySeconds = 30) {
    const browser = await puppeteer.launch({ headless: false });
    const page = await browser.newPage();

    console.log("üåê Going to Instagram page...");
    await page.goto("https://www.instagram.com/krungthai_care/", { waitUntil: "networkidle2" });
    await page.waitForSelector("article a");

    const postLinks = await page.$$eval("article a", links => links.map(a => a.href));
    const candidateLinks = postLinks.slice(0, count);

    const candidatePosts = [];
    for (const url of candidateLinks) {
        try {
            const post = await scrapePost(browser, url);
            candidatePosts.push(post);
        } catch (err) {
            console.error(`‚ùå Failed to scrape ${url}:`, err);
        }
    }

    candidatePosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    let lastPosts = fs.existsSync(lastPostFile) ? JSON.parse(fs.readFileSync(lastPostFile, "utf-8")) : [];

    for (const post of candidatePosts) {
        if (lastPosts.find(p => p.url === post.url)) {
            console.log(`‚è© Post already processed: ${post.url}`);
            continue;
        }

        const fileName = `post_${new Date(post.timestamp).toISOString().replace(/[:.]/g, "-")}.txt`;
        const filePath = path.join(folderPath, fileName);
        fs.writeFileSync(filePath, `URL: ${post.url}\nTimestamp: ${post.timestamp}\nCaption: ${post.caption}`);
        console.log(`üíæ Saved post to ${filePath}`);

        const mediaPath = await downloadMedia(post.media, fileName, post.url);

        // --- Check cache ---
        const geminiFile = path.join(geminiFolder, fileName.replace(".txt", "_gemini.txt"));
        let geminiOutput;
        if (fs.existsSync(geminiFile)) {
            geminiOutput = fs.readFileSync(geminiFile, "utf-8");
            console.log(`üìÇ Gemini response loaded from cache: ${geminiFile}`);
        } else {
            console.log("üì° Sending caption + media to Gemini...");
            geminiOutput = await analyzeWithGemini(post.caption, mediaPath, post.media.type);
            fs.writeFileSync(geminiFile, geminiOutput);
            console.log(`üíæ Gemini response saved to: ${geminiFile}`);

            console.log(`‚è≥ Waiting ${delaySeconds} seconds before next Gemini call...`);
            await new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));
        }

        // --- Check for "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠" AND "NOT COMPLY" to trigger email ---
        const isLoanAd = geminiOutput.toUpperCase().startsWith("‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠");
        const isNotComply = geminiOutput.toUpperCase().includes("NOT COMPLY");

        if (isLoanAd && isNotComply) {
            console.log("üö® Found a non-compliant loan ad. Sending email alert...");
            const customMailOptions = {
                subject: `üö® ACTION REQUIRED - NOT COMPLY Instagram Ad: ${post.timestamp}`
            };
            await sendEmail(post, geminiOutput, mediaPath, customMailOptions);
        } else {
            console.log("‚ÑπÔ∏è Post is either NOT an Ad or is COMPLY ‚Üí No email sent.");
        }

        lastPosts.push({ url: post.url, timestamp: post.timestamp });
    }

    fs.writeFileSync(lastPostFile, JSON.stringify(lastPosts));
    await browser.close();
}

// --- Cleanup old files after everything done ---
async function cleanupFiles() {
    const deleteFolderContents = (folder) => {
        if (fs.existsSync(folder)) {
            for (const file of fs.readdirSync(folder)) {
                const filePath = path.join(folder, file);
                if (fs.statSync(filePath).isFile()) {
                    fs.unlinkSync(filePath);
                }
            }
            console.log(`üßπ Cleared all files in ${folder}`);
        }
    };

    deleteFolderContents(folderPath); // ‡∏•‡∏ö caption + media ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
    deleteFolderContents(path.join(__dirname, "downloads")); // ‡∏•‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢ python
    deleteFolderContents(geminiFolder); // ‚úÖ ‡∏•‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å Gemini (‡πÑ‡∏ü‡∏•‡πå .txt)
}

// --- Run job ---
scrapeNewestPosts(3, 5)
    // .then(() => cleanupFiles())
    // .catch(err => console.error("‚ùå Error:", err));
